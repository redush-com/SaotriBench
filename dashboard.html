<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saotri Bench — Live Dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --bg-card: #161b22;
    --bg-row-alt: #1c2129;
    --border: #30363d;
    --text: #e6edf3;
    --text-dim: #8b949e;
    --green: #3fb950;
    --green-bg: rgba(63,185,80,0.12);
    --red: #f85149;
    --red-bg: rgba(248,81,73,0.12);
    --orange: #d29922;
    --orange-bg: rgba(210,153,34,0.12);
    --gray: #484f58;
    --accent: #58a6ff;
    --pulse: #3fb950;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
    font-size: 13px;
    line-height: 1.5;
    padding: 24px;
    min-height: 100vh;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  header h1 {
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }

  header h1 span {
    color: var(--accent);
  }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: var(--text-dim);
  }

  .pulse-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--pulse);
    animation: pulse 2s ease-in-out infinite;
  }

  .pulse-dot.error {
    background: var(--red);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(63,185,80,0.5); }
    50% { opacity: 0.6; box-shadow: 0 0 0 6px rgba(63,185,80,0); }
  }

  section {
    margin-bottom: 36px;
  }

  section h2 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  section h2 .badge {
    font-size: 11px;
    font-weight: 400;
    color: var(--text-dim);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1px 8px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  th, td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  th {
    background: var(--bg);
    color: var(--text-dim);
    font-weight: 500;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: sticky;
    top: 0;
  }

  tr:last-child td { border-bottom: none; }
  tr:nth-child(even) td { background: var(--bg-row-alt); }

  .cell-pass {
    color: var(--green);
    background: var(--green-bg) !important;
    font-weight: 600;
    text-align: center;
  }

  .cell-fail {
    color: var(--red);
    background: var(--red-bg) !important;
    font-weight: 600;
    text-align: center;
  }

  .cell-error {
    color: var(--orange);
    background: var(--orange-bg) !important;
    font-weight: 600;
    text-align: center;
  }

  .cell-na {
    color: var(--gray);
    text-align: center;
  }

  .cell-num {
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  .diff-easy { color: var(--green); }
  .diff-medium { color: var(--orange); }
  .diff-hard { color: var(--red); }

  .footnote {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 6px;
  }

  .loading {
    color: var(--text-dim);
    padding: 40px;
    text-align: center;
  }

  .progress-bar {
    width: 60px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
    margin-left: 6px;
  }

  .progress-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  .progress-fill.green { background: var(--green); }
  .progress-fill.orange { background: var(--orange); }
  .progress-fill.red { background: var(--red); }

  .sort-controls {
    display: inline-flex;
    gap: 4px;
    margin-left: 12px;
  }

  .sort-btn {
    background: var(--bg);
    color: var(--text-dim);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 2px 10px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  .sort-btn:hover {
    color: var(--text);
    border-color: var(--text-dim);
  }

  .sort-btn.active {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(88,166,255,0.08);
  }
</style>
</head>
<body>

<header>
  <h1>Saotri <span>Bench</span> — Live Dashboard</h1>
  <div class="status-bar">
    <div class="pulse-dot" id="statusDot"></div>
    <span id="statusText">Connecting...</span>
  </div>
</header>

<section id="summarySection">
  <h2>Completion Summary <span class="badge" id="summaryBadge">—</span>
    <span class="sort-controls">
      <button class="sort-btn active" data-sort="best" onclick="setSummarySort('best')">Best Results</button>
      <button class="sort-btn" data-sort="recent" onclick="setSummarySort('recent')">Most Recent</button>
    </span>
  </h2>
  <div id="summaryTable" class="loading">Loading...</div>
</section>

<section id="matrixSection">
  <h2>Pass / Fail Matrix <span class="badge" id="matrixBadge">latest run per model</span></h2>
  <div id="matrixTable" class="loading">Loading...</div>
</section>

<section id="difficultySection">
  <h2>By Difficulty <span class="badge" id="diffBadge">fully tested models</span></h2>
  <div id="difficultyTable" class="loading">Loading...</div>
</section>

<script>
const POLL_INTERVAL = 10_000;
let lastData = null;
let summarySort = 'best'; // 'best' | 'recent'

function setSummarySort(mode) {
  summarySort = mode;
  document.querySelectorAll('.sort-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.sort === mode);
  });
  if (lastData) renderSummary(lastData);
}

// ── Helpers ──────────────────────────────────────────────

function fmt(n, d = 1) {
  return Number(n).toFixed(d);
}

function fmtPct(n) {
  return (n * 100).toFixed(1) + '%';
}

function fmtDuration(s) {
  if (s < 60) return fmt(s, 0) + 's';
  if (s < 3600) return fmt(s / 60, 1) + 'm';
  return fmt(s / 3600, 1) + 'h';
}

function fmtTokens(n) {
  if (n >= 1_000_000) return fmt(n / 1_000_000, 1) + 'M';
  if (n >= 1_000) return fmt(n / 1_000, 1) + 'K';
  return String(n);
}

function diffClass(d) {
  return 'diff-' + (d || 'easy').toLowerCase();
}

function statusCell(run, totalPhases) {
  if (!run) return '<td class="cell-na">—</td>';
  const phases = run.phases_completed;
  const status = run.final_status;
  const label = `${phases}/${totalPhases}`;
  if (status === 'completed') return `<td class="cell-pass">PASS ${label}</td>`;
  if (status === 'error') return `<td class="cell-error">ERR ${label}</td>`;
  return `<td class="cell-fail">FAIL ${label}</td>`;
}

function progressBar(ratio) {
  const pct = Math.round(ratio * 100);
  let cls = 'green';
  if (ratio < 0.5) cls = 'red';
  else if (ratio < 0.8) cls = 'orange';
  return `<span class="progress-bar"><span class="progress-fill ${cls}" style="width:${pct}%"></span></span>`;
}

// ── Data Processing ──────────────────────────────────────

function buildLookup(data) {
  // { model -> { task_id -> run } }
  const lookup = {};
  for (const r of data.results) {
    const m = r.model_label;
    if (!lookup[m]) lookup[m] = {};
    lookup[m][r.task_id] = r;
  }
  return lookup;
}

function totalTaskCount(data) {
  return data.tasks.length;
}

// ── Render: Completion Summary ───────────────────────────

function renderSummary(data) {
  const lookup = buildLookup(data);
  const totalTasks = totalTaskCount(data);
  const totalPhasesAll = data.tasks.reduce((s, t) => s + t.total_phases, 0);

  const rows = [];
  for (const model of data.models) {
    const runs = lookup[model] || {};
    const tasksTested = Object.keys(runs).length;
    let tasksPassed = 0;
    let phasesCompleted = 0;
    let totalTokens = 0;
    let totalDuration = 0;
    let latestTimestamp = '';

    for (const r of Object.values(runs)) {
      if (r.final_status === 'completed') tasksPassed++;
      phasesCompleted += r.phases_completed;
      totalTokens += r.token_usage?.total_tokens || 0;
      totalDuration += r.total_duration_seconds || 0;
      if (r.timestamp && r.timestamp > latestTimestamp) latestTimestamp = r.timestamp;
    }

    const passRate = tasksTested > 0 ? tasksPassed / tasksTested : 0;
    const phaseRate = totalPhasesAll > 0 ? phasesCompleted / totalPhasesAll : 0;
    const incomplete = tasksTested < totalTasks;

    rows.push({
      model, tasksTested, tasksPassed, passRate,
      phasesCompleted, totalPhasesAll, phaseRate,
      totalTokens, totalDuration, incomplete, latestTimestamp
    });
  }

  if (summarySort === 'recent') {
    rows.sort((a, b) => b.latestTimestamp.localeCompare(a.latestTimestamp));
  } else {
    rows.sort((a, b) => b.passRate - a.passRate || b.phasesCompleted - a.phasesCompleted);
  }

  let html = `<table>
    <thead><tr>
      <th>Model</th>
      <th class="cell-num">Tasks Passed</th>
      <th class="cell-num">Pass Rate</th>
      <th class="cell-num">Phases Done</th>
      <th class="cell-num">Phase Rate</th>
      <th class="cell-num">Tokens</th>
      <th class="cell-num">Duration</th>
    </tr></thead><tbody>`;

  for (const r of rows) {
    const star = r.incomplete ? ' *' : '';
    html += `<tr>
      <td>${r.model}${star}</td>
      <td class="cell-num">${r.tasksPassed} / ${r.tasksTested}${star} ${progressBar(r.passRate)}</td>
      <td class="cell-num">${fmtPct(r.passRate)}</td>
      <td class="cell-num">${r.phasesCompleted} / ${r.totalPhasesAll}</td>
      <td class="cell-num">${fmtPct(r.phaseRate)}</td>
      <td class="cell-num">${fmtTokens(r.totalTokens)}</td>
      <td class="cell-num">${fmtDuration(r.totalDuration)}</td>
    </tr>`;
  }

  html += '</tbody></table>';

  const incompleteModels = rows.filter(r => r.incomplete).map(r => r.model);
  if (incompleteModels.length > 0) {
    html += `<div class="footnote">* Not all tasks tested yet: ${incompleteModels.join(', ')}</div>`;
  }

  document.getElementById('summaryBadge').textContent = `${rows.length} models`;
  document.getElementById('summaryTable').innerHTML = html;
}

// ── Render: Pass/Fail Matrix ─────────────────────────────

function renderMatrix(data) {
  const lookup = buildLookup(data);

  let html = `<table><thead><tr>
    <th>#</th><th>Task</th><th>Diff.</th><th>Phases</th>`;

  for (const m of data.models) {
    html += `<th style="text-align:center">${m}</th>`;
  }
  html += '</tr></thead><tbody>';

  for (const task of data.tasks) {
    const idx = task.task_id.replace('task_', '');
    html += `<tr>
      <td>${idx}</td>
      <td>${task.task_name}</td>
      <td class="${diffClass(task.difficulty)}">${task.difficulty}</td>
      <td class="cell-num">${task.total_phases}</td>`;

    for (const m of data.models) {
      const run = lookup[m]?.[task.task_id];
      html += statusCell(run, task.total_phases);
    }
    html += '</tr>';
  }

  html += '</tbody></table>';

  document.getElementById('matrixBadge').textContent = `${data.tasks.length} tasks x ${data.models.length} models`;
  document.getElementById('matrixTable').innerHTML = html;
}

// ── Render: By Difficulty ────────────────────────────────

function renderDifficulty(data) {
  const lookup = buildLookup(data);
  const difficulties = ['easy', 'medium', 'hard'];

  // Group tasks by difficulty
  const tasksByDiff = {};
  for (const d of difficulties) tasksByDiff[d] = [];
  for (const t of data.tasks) {
    const d = (t.difficulty || 'easy').toLowerCase();
    if (tasksByDiff[d]) tasksByDiff[d].push(t);
  }

  let html = `<table><thead><tr>
    <th>Difficulty</th><th>Tasks</th>`;

  for (const m of data.models) {
    html += `<th style="text-align:center">${m}</th>`;
  }
  html += '</tr></thead><tbody>';

  for (const diff of difficulties) {
    const tasks = tasksByDiff[diff];
    if (tasks.length === 0) continue;

    html += `<tr>
      <td class="${diffClass(diff)}" style="font-weight:600;text-transform:capitalize">${diff}</td>
      <td class="cell-num">${tasks.length}</td>`;

    for (const m of data.models) {
      const modelRuns = lookup[m] || {};
      let tested = 0;
      let passed = 0;
      for (const t of tasks) {
        const run = modelRuns[t.task_id];
        if (run) {
          tested++;
          if (run.final_status === 'completed') passed++;
        }
      }

      if (tested === 0) {
        html += '<td class="cell-na">—</td>';
      } else {
        const pct = fmtPct(passed / tasks.length);
        const partial = tested < tasks.length ? ' *' : '';
        const cls = passed === tasks.length ? 'cell-pass' :
                    passed === 0 ? 'cell-fail' : 'cell-error';
        html += `<td class="${cls}">${passed}/${tasks.length} (${pct})${partial}</td>`;
      }
    }
    html += '</tr>';
  }

  html += '</tbody></table>';
  html += '<div class="footnote">* Model has not been tested on all tasks in this difficulty group</div>';

  document.getElementById('diffBadge').textContent = `${data.models.length} models`;
  document.getElementById('difficultyTable').innerHTML = html;
}

// ── Poll Loop ────────────────────────────────────────────

async function fetchAndRender() {
  try {
    const resp = await fetch('/api/results');
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    lastData = data;

    renderSummary(data);
    renderMatrix(data);
    renderDifficulty(data);

    const now = new Date();
    const ts = now.toLocaleTimeString();
    document.getElementById('statusText').textContent = `Updated ${ts}`;
    document.getElementById('statusDot').classList.remove('error');
  } catch (err) {
    document.getElementById('statusText').textContent = `Error: ${err.message}`;
    document.getElementById('statusDot').classList.add('error');
  }
}

// Initial fetch + interval
fetchAndRender();
setInterval(fetchAndRender, POLL_INTERVAL);
</script>

</body>
</html>
